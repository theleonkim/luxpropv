@page "/forgot-password"

@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore
@using Luxprop.Data
@using Luxprop.Data.Models
@using Luxprop.Services

@inject LuxpropContext Db
@inject NavigationManager Navigation
@inject EmailService EmailService
@inject PasswordHelper PasswordHelper

<PageTitle>Forgot / Reset Password</PageTitle>

<div class="login-page">
    <main>
        <section class="login-container">

            <div class="login-header">
                <img src="https://i.imgur.com/nmN7x14.png" class="logo" />
                <span class="title">2CRRE Docs</span>
            </div>

            @if (!step2)
            {
                <!-- ============================
                     STEP 1: SEND TOKEN
                ============================== -->
                <h2>Forgot Password</h2>

                <EditForm Model="@emailModel" OnValidSubmit="@HandleSendToken">
                    <DataAnnotationsValidator />

                    <div class="form-group">
                        <label>Email</label>
                        <InputText class="form-control" @bind-Value="emailModel.Email" />
                        <ValidationMessage For="@(() => emailModel.Email)" />
                    </div>

                    <button class="btn btn-primary" disabled="@loading">
                        @(loading ? "Sending..." : "Send reset token")
                    </button>

                    @if (!string.IsNullOrEmpty(message))
                    {
                        <p class="info-message">@message</p>
                    }
                </EditForm>
            }
            else
            {
                <!-- ============================
                     STEP 2: ENTER TOKEN + NEW PASSWORD
                ============================== -->
                <h2>Reset Password</h2>

                <EditForm Model="@resetModel" OnValidSubmit="@HandleResetPassword">
                    <DataAnnotationsValidator />

                    <div class="form-group">
                        <label>Token</label>
                        <InputText class="form-control" @bind-Value="resetModel.Token" />
                        <ValidationMessage For="@(() => resetModel.Token)" />
                    </div>

                    <div class="form-group">
                        <label>New Password</label>
                        <InputText type="password" class="form-control" @bind-Value="resetModel.Password" />
                        <ValidationMessage For="@(() => resetModel.Password)" />
                    </div>

                    <div class="form-group">
                        <label>Confirm Password</label>
                        <InputText type="password" class="form-control" @bind-Value="resetModel.ConfirmPassword" />
                        <ValidationMessage For="@(() => resetModel.ConfirmPassword)" />
                    </div>

                    <button class="btn btn-primary" disabled="@loading">
                        @(loading ? "Saving..." : "Reset Password")
                    </button>

                    @if (!string.IsNullOrEmpty(message))
                    {
                        <p class="info-message">@message</p>
                    }
                </EditForm>
            }

            <div class="forgot-container" style="text-align:center; margin-top:1rem;">
                <a href="/login" class="forgot-link">Back to Login</a>
            </div>

        </section>
    </main>
</div>


@code {
    // STEP CONTROL
    private bool step2 = false;

    // MODELS
    private EmailVM emailModel = new();
    private ResetVM resetModel = new();

    // FLAGS
    private bool loading = false;
    private string message = "";

    // STEP 1 – SEND TOKEN
    private async Task HandleSendToken()
    {
        loading = true;
        message = "";

        var user = await Db.Usuarios.FirstOrDefaultAsync(x => x.Email == emailModel.Email);

        if (user == null)
        {
            message = "If the email exists, a token has been sent.";
            loading = false;
            return;
        }

        string token = Guid.NewGuid().ToString("N");

        user.ResetPasswordToken = token;
        user.ResetPasswordExpiration = DateTime.UtcNow.AddHours(1);

        await Db.SaveChangesAsync();

        await EmailService.SendPasswordResetEmail(user.Email, token);

        message = "A recovery token has been sent to your email.";
        step2 = true;
        loading = false;
    }

    // STEP 2 – RESET PASSWORD
    private async Task HandleResetPassword()
    {
        loading = true;
        message = "";

        if (resetModel.Password != resetModel.ConfirmPassword)
        {
            message = "Passwords do not match.";
            loading = false;
            return;
        }

        var user = await Db.Usuarios.FirstOrDefaultAsync(u =>
            u.ResetPasswordToken == resetModel.Token &&
            u.ResetPasswordExpiration > DateTime.UtcNow);

        if (user == null)
        {
            message = "Invalid or expired token.";
            loading = false;
            return;
        }

        user.Password = PasswordHelper.HashPassword(resetModel.Password);
        user.ResetPasswordToken = null;
        user.ResetPasswordExpiration = null;

        await Db.SaveChangesAsync();

        message = "Password updated successfully.";

        await Task.Delay(1500);
        Navigation.NavigateTo("/login", true);
    }

    // MODELS
    public class EmailVM { public string Email { get; set; } = ""; }

    public class ResetVM
    {
        public string Token { get; set; } = "";
        public string Password { get; set; } = "";
        public string ConfirmPassword { get; set; } = "";
    }
}


<style>
    .login-page {
        margin: 0;
        background-color: #f5f5f5;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: 'Montserrat', sans-serif;
    }

    .login-container {
        width: 420px;
        background-color: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 4px 18px rgba(0,0,0,0.1);
    }

    .login-header {
        background-color: #0d505a;
        padding: 1.5rem 0;
        border-radius: 10px;
        text-align: center;
        margin-bottom: 1.8rem;
    }

        .login-header .logo {
            height: 60px;
            margin-bottom: 0.5rem;
        }

        .login-header .title {
            color: white;
            font-size: 1.4rem;
            font-weight: 600;
        }

    h2 {
        text-align: center;
        color: #0d505a;
        margin-bottom: 2rem;
        font-weight: 700;
    }

    .form-group {
        margin-bottom: 1.2rem;
    }

    label {
        font-weight: 600;
        margin-bottom: 0.3rem;
        display: block;
    }

    .form-control {
        width: 100%;
        padding: 0.6rem;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 1rem;
    }

    .btn {
        width: 100%;
        padding: 0.75rem;
        border-radius: 6px;
        font-size: 1rem;
        font-weight: 600;
        border: none;
        margin-bottom: 0.6rem;
        cursor: pointer;
    }

    .btn-primary {
        background-color: #0d505a;
        color: #fff;
    }

    .error-message {
        color: red;
        text-align: center;
        margin-top: 1rem;
        font-weight: 500;
    }

    .info-message {
        color: #0d505a;
        text-align: center;
        margin-top: 1rem;
    }

    .forgot-link {
        color: #0d505a;
        text-decoration: none;
    }
</style>
