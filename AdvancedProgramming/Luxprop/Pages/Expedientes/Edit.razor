@page "/expedientes/edit/{ExpedienteId:int}"
@using Luxprop.Business.Services
@using Luxprop.Data.Models
@using Microsoft.EntityFrameworkCore
@inject LuxpropContext Db
@inject NavigationManager Navigation
@inject Luxprop.Services.SessionService Session
@inject IDocumentoService DocumentoService


<h3 class="mb-3">Edit Case File</h3>

@if (expediente == null)
{
    <div class="alert alert-warning">Case file not found.</div>
}
else
{
    <EditForm Model="expediente" OnValidSubmit="GuardarCambios">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <!-- Case Info -->
        <div class="card p-4 shadow-sm mb-4">
            <h5 class="fw-bold text-primary">Case File Information</h5>
            <hr />

            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Type of Occupation</label>
                    <InputText class="form-control" @bind-Value="expediente.TipoOcupacion" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Status</label>
                    <InputSelect class="form-select" @bind-Value="expediente.Estado">
                        <option value="Abierto">Open</option>
                        <option value="En proceso">In Progress</option>
                        <option value="Cerrado">Closed</option>
                    </InputSelect>
                </div>
            </div>

            @if (expediente.Estado == "Cerrado")
            {
                <div class="mb-3">
                    <label class="form-label">Closing Date</label>
                    <InputDate class="form-control" @bind-Value="expediente.FechaCierre" />
                </div>
            }

            <label class="form-label">Description (History Log):</label>
            <InputTextArea class="form-control" rows="3" @bind-Value="descripcionHistorial" />

            <div class="card p-4 shadow-sm mb-4">
                <h5 class="fw-bold text-primary">Documents</h5>
                <hr />

                <InputFile OnChange="GuardarArchivoTemporal" class="form-control mb-2" />

                @if (!string.IsNullOrEmpty(nombreArchivoTemporal))
                {
                    <small class="text-success">
                        File ready to upload: @nombreArchivoTemporal (will be saved on Save Changes)
                    </small>
                }

                @if (documentos != null && documentos.Any())
                {
                    <table class="table modern-doc-table mt-3">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th class="text-center" style="width:150px;">Actions</th>
                            </tr>
                        </thead>

                        <tbody>
                            @foreach (var d in documentos)
                            {
                                <tr>
                                    <td>@d.Nombre</td>
                                    <td>@d.FechaCarga?.ToString("yyyy-MM-dd")</td>
                                    <td>
                                        <span class="badge status-badge">@d.Estado</span>
                                    </td>

                                    <td class="text-center">
                                        <div class="btn-group-docs">

                                            @if (!string.IsNullOrEmpty(d.UrlArchivo))
                                            {
                                                <a href="@d.UrlArchivo" target="_blank"
                                                   class="btn-doc btn-doc-download">
                                                    <i class="bi bi-download"></i> Download
                                                </a>
                                            }

                                            <button class="btn-doc btn-doc-delete"
                                                    @onclick="() => EliminarDocumento(d.DocumentoId)">
                                                <i class="bi bi-trash"></i> Delete
                                            </button>

                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p class="text-muted">No documents uploaded yet.</p>
                }
            </div>


            <div class="mt-3 text-end">
                <button class="btn btn-primary me-2">Save Changes</button>
                <button type="button" class="btn btn-secondary" @onclick="Volver">Cancel</button>
            </div>
        </div>

    </EditForm>

    <!-- TASKS -->
    <div class="card p-4 shadow-sm mb-4">
        <h5 class="fw-bold text-primary">Process Tasks</h5>
        <hr />

        <EditForm Model="nuevaTarea" OnValidSubmit="AgregarTarea">
            <div class="row g-2 mb-3">
                <div class="col-md-5">
                    <InputText class="form-control" @bind-Value="nuevaTarea.Titulo" placeholder="Task Title" />
                </div>
                <div class="col-md-5">
                    <InputText class="form-control" @bind-Value="nuevaTarea.Estado" placeholder="Status (Pending, Done…)" />
                </div>
                <div class="col-md-2">
                    <button class="btn btn-success w-100">Add</button>
                </div>
            </div>
        </EditForm>

        @if (tareas != null && tareas.Any())
        {
            <table class="table table-striped">
                <thead class="table-light">
                    <tr>
                        <th>Title</th>
                        <th>Status</th>
                        <th style="width:100px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var t in tareas)
                    {
                        <tr>
                            <td>@t.Titulo</td>
                            <td>@t.Estado</td>
                            <td>
                                <button class="btn btn-sm btn-danger" @onclick="() => EliminarTarea(t.TareaId)">Delete</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <p>No tasks registered.</p>
        }
    </div>

    <!-- HISTORY -->
    <div class="card p-4 shadow-sm">
        <h5 class="fw-bold text-primary">History Log</h5>
        <hr />

        @if (historial != null && historial.Any())
        {
            <table class="table table-bordered table-sm">
                <thead class="table-light">
                    <tr>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var h in historial)
                    {
                        <tr>
                            <td>@h.FechaModificacion</td>
                            <td>@h.EstadoNuevo</td>
                            <td>@h.Descripcion</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <p>No history yet.</p>
        }
    </div>
}

@code {
    [Parameter] public int ExpedienteId { get; set; }
    private Expediente? expediente;
    private List<Documento>? documentos;
    private List<HistorialExpediente>? historial;
    private List<TareaTramite>? tareas;

    private string descripcionHistorial = "";
    private TareaTramite nuevaTarea = new();
    private IBrowserFile? archivoTemporal;
    private string? nombreArchivoTemporal;

    protected override async Task OnInitializedAsync()
    {
        expediente = await Db.Expedientes
            .Include(e => e.Cliente).ThenInclude(c => c.Usuario)
            .Include(e => e.Documentos)
            .FirstOrDefaultAsync(e => e.ExpedienteId == ExpedienteId);

        documentos = expediente?.Documentos.ToList();

        tareas = await Db.TareaTramites.Where(t => t.ExpedienteId == ExpedienteId).ToListAsync();

        historial = await Db.HistorialExpedientes.Where(h => h.ExpedienteId == ExpedienteId)
                                                 .OrderByDescending(h => h.FechaModificacion)
                                                 .ToListAsync();
    }

    private void GuardarArchivoTemporal(InputFileChangeEventArgs e)
    {
        archivoTemporal = e.File;
        nombreArchivoTemporal = archivoTemporal.Name;
    }

    private async Task GuardarCambios()
    {

        int usuarioId = await Session.GetUserIdAsync();


        if (expediente != null)
        {
            expediente.UltimaActualizacion = DateTime.Now;
        }

        // Save expediente
        Db.Expedientes.Update(expediente!);

        // Save history
        Db.HistorialExpedientes.Add(new HistorialExpediente
        {
            ExpedienteId = expediente!.ExpedienteId,
            UsuarioId = usuarioId,
            FechaModificacion = DateTime.Now,
            EstadoNuevo = expediente.Estado,
            Descripcion = string.IsNullOrWhiteSpace(descripcionHistorial) ? "Case updated." : descripcionHistorial
        });

        // Save document if exists
        // 🔥 NUEVO: Subir documento a Firebase usando DocumentoService
        if (archivoTemporal != null)
        {
            

            using var stream = archivoTemporal.OpenReadStream(10_000_000);

            string url = await DocumentoService.UploadFileAsync(
                stream,
                archivoTemporal.Name,
                archivoTemporal.ContentType
            );

            var nuevoDoc = new Documento
            {
                Nombre = archivoTemporal.Name,
                TipoDocumento = archivoTemporal.ContentType,
                FechaCarga = DateOnly.FromDateTime(DateTime.Now),
                Estado = "Activo",
                UrlArchivo = url,                // 🔥 URL pública
                ExpedienteId = expediente.ExpedienteId,
                FechaVencimiento = null          // opcional: puedes agregar campo input si quieres
            };

            Db.Documentos.Add(nuevoDoc);

            await DocumentoService.UpdateExpedienteStatusAsync(expediente.ExpedienteId, usuarioId);
        }


        await Db.SaveChangesAsync();
        Navigation.NavigateTo($"/expedientes/details/{expediente.ExpedienteId}");
    }

    private async Task EliminarDocumento(int id)
    {
        int usuarioId = await Session.GetUserIdAsync();

        var doc = await Db.Documentos.FindAsync(id);
        if (doc == null) return;

        if (!string.IsNullOrEmpty(doc.UrlArchivo))
        {
            await DocumentoService.DeleteFileAsync(doc.UrlArchivo, doc.ExpedienteId, usuarioId);
        }

        Db.Documentos.Remove(doc);
        await Db.SaveChangesAsync();

        documentos = await Db.Documentos
            .Where(d => d.ExpedienteId == ExpedienteId)
            .ToListAsync();

        await DocumentoService.UpdateExpedienteStatusAsync(ExpedienteId, usuarioId);
    }


    private async Task AgregarTarea()
    {
        nuevaTarea.ExpedienteId = ExpedienteId;
        nuevaTarea.FechaInicio = DateTime.Now;

        Db.TareaTramites.Add(nuevaTarea);
        await Db.SaveChangesAsync();

        tareas = await Db.TareaTramites.Where(t => t.ExpedienteId == ExpedienteId).ToListAsync();
        nuevaTarea = new();
    }

    private async Task EliminarTarea(int id)
    {
        var tarea = await Db.TareaTramites.FindAsync(id);
        if (tarea != null)
        {
            Db.TareaTramites.Remove(tarea);
            await Db.SaveChangesAsync();
            tareas = await Db.TareaTramites.Where(t => t.ExpedienteId == ExpedienteId).ToListAsync();
        }
    }

    private void Volver() => Navigation.NavigateTo("/expedientes");
}
<style>
    /* Tabla moderna */
    .modern-doc-table {
        border-collapse: separate;
        border-spacing: 0 6px;
    }

        .modern-doc-table thead tr {
            background: #f5f8fa;
        }

        .modern-doc-table tbody tr {
            background: white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .modern-doc-table td,
        .modern-doc-table th {
            padding: 12px 16px !important;
            vertical-align: middle;
        }

    /* Badges para estados */
    .status-badge {
        background-color: #0d505a;
        color: white;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.75rem;
    }

    /* Contenedor de botones */
    .btn-group-docs {
        display: flex;
        gap: 8px;
        justify-content: center;
    }

    /* Botón base */
    .btn-doc {
        padding: 5px 12px;
        font-size: 0.78rem;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        border: 2px solid transparent;
        transition: .2s ease;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }

    /* Botón verde corporativo: Download */
    .btn-doc-download {
        color: #0d505a;
        border-color: #0d505a;
        background: white;
    }

        .btn-doc-download:hover {
            background: #0d505a;
            color: white;
        }

    /* Botón rojo: Delete */
    .btn-doc-delete {
        color: #a01d1d;
        border-color: #a01d1d;
        background: white;
    }

        .btn-doc-delete:hover {
            background: #a01d1d;
            color: white;
        }


</style>