@using Luxprop.Data.Models
@using Microsoft.EntityFrameworkCore
@using Luxprop.Services

@inject LuxpropContext Db
@inject SessionService Session

<PageTitle>Properties - Luxprop</PageTitle>

<div class="properties-page">
    <div class="page-header">
        <h1>Properties</h1>
    </div>

    @if (items is null)
    {
        <div class="loading">Loading properties...</div>
    }
    else if (!items.Any())
    {
        <div class="no-data">No properties available.</div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var p in items)
                    {
                        <tr>
                            <td>@p.PropiedadId</td>
                            <td>@p.Titulo</td>
                            <td>@p.EstadoPublicacion</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private List<Propiedad>? items;
    private int? currentUserId;
    private string? currentRole;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        currentUserId = await Session.GetUserIdAsync();
        currentRole = await Session.GetUserRoleAsync();

        await LoadAsync();
        StateHasChanged();
    }

    private async Task LoadAsync()
    {
        IQueryable<Propiedad> query = Db.Propiedads.AsNoTracking();

        // Optional filtering by agent (if your model has agent assignment)
        // if (!string.Equals(currentRole, "Admin", StringComparison.OrdinalIgnoreCase) && currentUserId.HasValue)
        // {
        //     query = query.Where(p => p.AgentId == currentUserId.Value);
        // }

        items = await query.ToListAsync();
    }
}

<style>
    .properties-page {
        padding: 2rem;
    }

    .page-header h1 {
        color: #0d505a;
        font-weight: 700;
        margin-bottom: 1.5rem;
    }

    .table-responsive {
        overflow-x: auto;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }

        .table th {
            background-color: #0d505a;
            color: white;
            font-size: .85rem;
            text-transform: uppercase;
            padding: 1rem;
        }

        .table td {
            padding: 1rem;
            border-bottom: 1px solid #e2e2e2;
            vertical-align: middle;
        }

        .table tbody tr:hover {
            background-color: #f1f5f6;
        }

    .loading,
    .no-data {
        text-align: center;
        padding: 2rem;
        font-size: 1.2rem;
        color: #0d505a;
    }
</style>
