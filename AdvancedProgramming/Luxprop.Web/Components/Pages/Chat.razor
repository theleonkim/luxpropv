@page "/chat"
@using Luxprop.Data
@using Luxprop.Data.Models
@using Luxprop.Web.Models.Chat
@using System.Diagnostics
@inject LuxpropContext Db
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation

<PageTitle>Chat - Luxprop</PageTitle>

<div class="chat-page">
    <div class="page-header">
        <h1>Chat Support</h1>
        <div class="chat-controls">
            @if (currentThreadId > 0)
            {
                <button class="btn btn-danger" @onclick="CloseThread">Close Thread</button>
            }
            <button class="btn btn-secondary" @onclick="StartNewChat">New Chat</button>
        </div>
    </div>

    <div class="chat-container">
        <div class="chat-messages" @ref="messagesContainer">
            @if (messages?.Any() == true)
            {
                @foreach (var message in messages)
                {
                    <div class="message @(message.Sender.ToLower())">
                        <div class="message-header">
                            <span class="sender">@message.Sender</span>
                            <span class="timestamp">@message.SentUtc.ToString("HH:mm")</span>
                        </div>
                        <div class="message-content">@message.Text</div>
                    </div>
                }
            }
            else
            {
                <div class="no-messages">
                    <p>Start a conversation by typing a message below.</p>
                </div>
            }
        </div>

        <div class="chat-input">
            <EditForm Model="@newMessage" OnValidSubmit="@SendMessage">
                <div class="input-group">
                    <InputText @bind-Value="newMessage.Text" 
                               class="form-control" 
                               placeholder="Type your message..." 
                               disabled="@(currentThreadId <= 0)" />
                    <button type="submit" 
                            class="btn btn-primary" 
                            disabled="@(currentThreadId <= 0 || string.IsNullOrWhiteSpace(newMessage.Text))">
                        Send
                    </button>
                </div>
            </EditForm>
        </div>
    </div>

    @if (currentThreadId <= 0)
    {
        <div class="chat-init">
            <div class="init-form">
                <h3>Start a New Chat</h3>
                <EditForm Model="@chatInit" OnValidSubmit="@InitializeChat">
                    <div class="form-group">
                        <label for="clientName">Your Name</label>
                        <InputText id="clientName" @bind-Value="chatInit.ClientName" class="form-control" />
                        <ValidationMessage For="@(() => chatInit.ClientName)" />
                    </div>
                    <div class="form-group">
                        <label for="clientEmail">Your Email</label>
                        <InputText id="clientEmail" @bind-Value="chatInit.ClientEmail" class="form-control" />
                        <ValidationMessage For="@(() => chatInit.ClientEmail)" />
                    </div>
                    <button type="submit" class="btn btn-primary">Start Chat</button>
                </EditForm>
            </div>
        </div>
    }
</div>

@code {
    private int currentThreadId = 0;
    private List<ChatMessage>? messages;
    private ChatInitModel chatInit = new();
    private ChatMessage newMessage = new();
    private ElementReference messagesContainer;
    private Timer? pollTimer;

    protected override async Task OnInitializedAsync()
    {
        // Initialize without JavaScript calls
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Check if user is logged in and get their info
                var userName = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", "UsuarioNombre");
                var userEmail = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", "UsuarioEmail");
                
                if (!string.IsNullOrEmpty(userName))
                {
                    chatInit.ClientName = userName;
                }
                if (!string.IsNullOrEmpty(userEmail))
                {
                    chatInit.ClientEmail = userEmail;
                }
                
                StateHasChanged(); // Refresh the UI with the loaded data
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading user data: {ex.Message}");
            }
            
            if (currentThreadId > 0)
            {
                await ScrollToBottom();
            }
        }
    }

    private async Task InitializeChat()
    {
        try
        {
            // Create or get existing thread
            var thread = Db.ChatThreads
                .Where(t => t.State == "Open" && t.ClientEmail == chatInit.ClientEmail)
                .OrderByDescending(t => t.CreatedUtc)
                .FirstOrDefault();

            if (thread == null)
            {
                thread = new ChatThread
                {
                    ClientName = chatInit.ClientName,
                    ClientEmail = chatInit.ClientEmail,
                    State = "Open",
                    CreatedUtc = DateTime.UtcNow,
                    NeedsAgent = false
                };
                Db.ChatThreads.Add(thread);
                await Db.SaveChangesAsync();

                // Add welcome messages
                await AddBotMessage(thread.ChatThreadId, "Hello! I'm Marty assistant ðŸ¤–.");
                await AddBotMessage(thread.ChatThreadId, GetMainMenu());
            }

            currentThreadId = thread.ChatThreadId;
            await LoadMessages();
            StartPolling();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing chat: {ex.Message}");
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(newMessage.Text) || currentThreadId <= 0)
            return;

        try
        {
            var message = new ChatMessage
            {
                ChatThreadId = currentThreadId,
                Text = newMessage.Text.Trim(),
                Sender = "Client",
                SentUtc = DateTime.UtcNow
            };

            Db.ChatMessages.Add(message);

            // Mark thread as needing agent
            var thread = Db.ChatThreads.Find(currentThreadId);
            if (thread != null)
            {
                thread.NeedsAgent = true;
            }

            await Db.SaveChangesAsync();

            newMessage.Text = string.Empty;
            await LoadMessages();
            await ScrollToBottom();

            // Bot response
            await ProcessBotResponse(message.Text);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error sending message: {ex.Message}");
        }
    }

    private async Task ProcessBotResponse(string userInput)
    {
        try
        {
            var response = GetBotResponse(userInput);
            if (!string.IsNullOrEmpty(response))
            {
                await AddBotMessage(currentThreadId, response);
                await LoadMessages();
                await ScrollToBottom();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error processing bot response: {ex.Message}");
        }
    }

    private async Task AddBotMessage(int threadId, string text)
    {
        var botMessage = new ChatMessage
        {
            ChatThreadId = threadId,
            Text = text,
            Sender = "Bot",
            SentUtc = DateTime.UtcNow
        };
        Db.ChatMessages.Add(botMessage);
        await Db.SaveChangesAsync();
    }

    private async Task LoadMessages()
    {
        if (currentThreadId <= 0) return;

        try
        {
            messages = Db.ChatMessages
                .Where(m => m.ChatThreadId == currentThreadId)
                .OrderBy(m => m.ChatMessageId)
                .ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading messages: {ex.Message}");
        }
    }

    private async Task CloseThread()
    {
        if (currentThreadId <= 0) return;

        try
        {
            var thread = Db.ChatThreads.Find(currentThreadId);
            if (thread != null)
            {
                thread.State = "Closed";
                thread.ClosedUtc = DateTime.UtcNow;
                thread.NeedsAgent = false;
                await Db.SaveChangesAsync();
            }

            StopPolling();
            currentThreadId = 0;
            messages = null;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error closing thread: {ex.Message}");
        }
    }

    private async Task StartNewChat()
    {
        await CloseThread();
        chatInit = new ChatInitModel();
        
        // Reset user info if available
        var userName = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", "UsuarioNombre");
        var userEmail = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", "UsuarioEmail");
        
        if (!string.IsNullOrEmpty(userName))
        {
            chatInit.ClientName = userName;
        }
        if (!string.IsNullOrEmpty(userEmail))
        {
            chatInit.ClientEmail = userEmail;
        }
    }

    private void StartPolling()
    {
        pollTimer = new Timer(async _ => await PollForNewMessages(), null, TimeSpan.Zero, TimeSpan.FromSeconds(2));
    }

    private void StopPolling()
    {
        pollTimer?.Dispose();
        pollTimer = null;
    }

    private async Task PollForNewMessages()
    {
        if (currentThreadId <= 0) return;

        try
        {
            var lastMessageId = messages?.LastOrDefault()?.ChatMessageId ?? 0;
            var newMessages = Db.ChatMessages
                .Where(m => m.ChatThreadId == currentThreadId && m.ChatMessageId > lastMessageId)
                .OrderBy(m => m.ChatMessageId)
                .ToList();

            if (newMessages.Any())
            {
                messages?.AddRange(newMessages);
                await InvokeAsync(StateHasChanged);
                await ScrollToBottom();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error polling messages: {ex.Message}");
        }
    }

    private async Task ScrollToBottom()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("scrollToBottom", messagesContainer);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error scrolling to bottom: {ex.Message}");
        }
    }

    private string GetMainMenu()
    {
        return "Please choose an option:\n" +
               "1) Plans & pricing\n" +
               "2) Documentation\n" +
               "3) Business hours & contact\n" +
               "9) Talk to a human agent\n" +
               "0) Back to menu";
    }

    private string GetBotResponse(string input)
    {
        var q = (input ?? "").Trim().ToLowerInvariant();

        if (q == "0")
        {
            return GetMainMenu();
        }

        if (q == "9" || q.Contains("agent"))
        {
            return "Okay! I'll notify an agent. Please hold on...";
        }

        if (q == "1" || q.Contains("price") || q.Contains("plan"))
        {
            return "We offer Basic ($29), Pro ($79), and Enterprise (custom).\nType 9 for an agent or 0 to go back.";
        }

        if (q == "2" || q.Contains("doc"))
        {
            return "Docs: go to Help â†’ Documentation in the top menu.\nType 9 for an agent or 0 to go back.";
        }

        if (q == "3" || q.Contains("contact") || q.Contains("phone") || q.Contains("email"))
        {
            return "We're online Monâ€“Fri, 9amâ€“6pm (GMT-6).\nEmail: support@example.com | Phone: +506 0000-0000.\nType 9 for an agent or 0 to go back.";
        }

        return "I didn't get that.\n" + GetMainMenu();
    }

    public void Dispose()
    {
        StopPolling();
    }
}

<style>
    .chat-page {
        padding: 2rem;
        height: 100vh;
        display: flex;
        flex-direction: column;
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #0d505a;
    }

    .page-header h1 {
        margin: 0;
        color: #0d505a;
    }

    .chat-controls {
        display: flex;
        gap: 0.5rem;
    }

    .chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .chat-messages {
        flex: 1;
        padding: 1rem;
        overflow-y: auto;
        max-height: 60vh;
    }

    .message {
        margin-bottom: 1rem;
        padding: 0.75rem;
        border-radius: 8px;
        max-width: 70%;
    }

    .message.client {
        background-color: #0d505a;
        color: white;
        margin-left: auto;
    }

    .message.bot, .message.agent {
        background-color: #f8f9fa;
        color: #333;
        border: 1px solid #dee2e6;
    }

    .message-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        font-size: 0.8rem;
        opacity: 0.8;
    }

    .message-content {
        white-space: pre-wrap;
    }

    .no-messages {
        text-align: center;
        color: #666;
        padding: 2rem;
    }

    .chat-input {
        padding: 1rem;
        border-top: 1px solid #dee2e6;
        background-color: #f8f9fa;
    }

    .input-group {
        display: flex;
        gap: 0.5rem;
    }

    .form-control {
        flex: 1;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
    }

    .form-control:focus {
        outline: none;
        border-color: #0d505a;
        box-shadow: 0 0 0 2px rgba(13, 80, 90, 0.2);
    }

    .chat-init {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .init-form {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        min-width: 400px;
    }

    .init-form h3 {
        margin-top: 0;
        color: #0d505a;
        text-align: center;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 4px;
        text-decoration: none;
        border: 1px solid transparent;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.2s;
    }

    .btn-primary {
        background-color: #0d505a;
        color: white;
        border-color: #0d505a;
    }

    .btn-primary:hover:not(:disabled) {
        background-color: #093e47;
        border-color: #093e47;
    }

    .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
        border-color: #6c757d;
    }

    .btn-secondary:hover {
        background-color: #545b62;
        border-color: #545b62;
    }

    .btn-danger {
        background-color: #dc3545;
        color: white;
        border-color: #dc3545;
    }

    .btn-danger:hover {
        background-color: #c82333;
        border-color: #c82333;
    }
</style>
